require 'base64'
require 'openssl'

# https://github.com/rails/rails/blob/master/activesupport/lib/active_support/encrypted_file.rb
# key_path.binread.strip
# ActiveSupport::MessageEncryptor.new([ key ].pack("H*"), cipher: CIPHER)
# CIPHER = "aes-128-gcm"

# https://github.com/rails/rails/blob/master/activesupport/lib/active_support/message_encryptor.rb

#cipher = new_cipher

key = [File.read("master.key")].pack("H*")

str = File.read("credentials.yml.enc")

encrypted_data, iv, auth_tag = str.split("--").map { |v| ::Base64.strict_decode64(v) }

cipher = OpenSSL::Cipher.new("aes-128-gcm")
cipher.decrypt
cipher.key = key
cipher.iv  = iv
cipher.auth_tag = auth_tag
cipher.auth_data = ""

decrypted_data = cipher.update(encrypted_data)
decrypted_data << cipher.final
puts decrypted_data
